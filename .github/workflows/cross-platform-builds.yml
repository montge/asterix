name: Cross-Platform Builds (Windows/macOS/Linux)

on:
  push:
    branches: [ master, develop, 'feature/**', 'cross-platform/**' ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (Release/Debug)'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
          - Both

permissions:
  contents: read

env:
  CMAKE_VERSION: '3.20'
  CPACK_VERBOSITY: 1

jobs:
  # =============================================================================
  # WINDOWS BUILD (MSVC 2022, C++23)
  # =============================================================================
  build-windows:
    name: Windows ${{ matrix.os }} - ${{ matrix.config }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022]
        config: [Release, Debug]
        include:
          - os: windows-2022
            msvc_version: '2022'
            toolset: 'v143'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install vcpkg
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location

    - name: Install dependencies (vcpkg)
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    - name: Configure CMake (C++20 for MSVC)
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
          -DCMAKE_CXX_STANDARD=20 `
          -DCMAKE_CXX_STANDARD_REQUIRED=ON `
          -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DBUILD_SHARED_LIBS=ON `
          -DBUILD_STATIC_LIBS=ON `
          -DBUILD_EXECUTABLE=ON `
          -DBUILD_TESTING=OFF `
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install"

    - name: Build
      shell: pwsh
      run: |
        cmake --build build --config ${{ matrix.config }} --parallel 4

    - name: Install
      shell: pwsh
      run: |
        cmake --install build --config ${{ matrix.config }}

    - name: Test executable
      shell: pwsh
      run: |
        $exe = "${{ github.workspace }}/install/bin/asterix.exe"
        if (Test-Path $exe) {
          & $exe --help
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Help command failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          & $exe --version
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Version command failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
        } else {
          Write-Host "::error::Executable not found at $exe"
          Get-ChildItem -Path "${{ github.workspace }}" -Filter "asterix.exe" -Recurse -ErrorAction SilentlyContinue
          exit 1
        }

    - name: Run basic integration tests (Windows)
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $exe = "${{ github.workspace }}/install/bin/asterix.exe"
        $config = "${{ github.workspace }}/asterix/config/asterix.ini"

        # Test 1: Help output
        Write-Host "=== Test 1: Help ===" -ForegroundColor Cyan
        & $exe --help
        if ($LASTEXITCODE -ne 0) {
          Write-Host "::error::Help test failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

        # Test 2: Version output
        Write-Host "`n=== Test 2: Version ===" -ForegroundColor Cyan
        & $exe --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "::error::Version test failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

        # Test 3: List filters (if available)
        Write-Host "`n=== Test 3: Filters ===" -ForegroundColor Cyan
        & $exe -d $config -L 2>&1 | Out-Null
        if ($LASTEXITCODE -ne 0) {
          Write-Host "::error::Filter test failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

        Write-Host "`n=== Tests completed ===" -ForegroundColor Green

    - name: Create Windows installers (Windows 2022 Release only)
      if: matrix.os == 'windows-2022' && matrix.config == 'Release'
      run: |
        cd build

        # Create ZIP archive (always works)
        Write-Host "Creating ZIP package..."
        cpack -G ZIP -C Release

        # Install WiX Toolset for MSI creation (enterprise standard)
        Write-Host "`nInstalling WiX Toolset for MSI..."
        choco install wixtoolset -y --no-progress 2>$null || Write-Host "WiX install skipped"

        # Create MSI installer using WiX
        $wixPath = "$env:WIX\bin\candle.exe"
        if (Test-Path $wixPath) {
          Write-Host "Creating MSI installer with WiX..."
          cpack -G WIX -C Release
          Write-Host "✅ MSI created successfully"
        } else {
          Write-Host "⚠️  WiX not available - MSI creation skipped"
        }

        # Install NSIS for alternative .exe installer
        Write-Host "`nInstalling NSIS for EXE installer..."
        choco install nsis -y --no-progress 2>$null || Write-Host "NSIS install skipped"

        # Create NSIS .exe installer
        $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        if (Test-Path $nsisPath) {
          Write-Host "Creating NSIS .exe installer..."
          cpack -G NSIS -C Release
          Write-Host "✅ NSIS installer created successfully"
        } else {
          Write-Host "⚠️  NSIS not available - EXE creation skipped"
        }

        # List all created packages
        Write-Host "`n=== Created Packages ==="
        Get-ChildItem -Filter "asterix*" | Format-Table Name, Length
      shell: pwsh

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v5
      with:
        name: asterix-windows-${{ matrix.os }}-${{ matrix.config }}
        path: |
          install/bin/asterix.exe
          install/bin/*.dll
          install/lib/*.lib
          install/include/
          asterix/config/
          build/*.zip
          build/*.exe
          build/*.msi
          build/*.zip
        retention-days: 14

  # =============================================================================
  # MACOS BUILD (AppleClang 15+, C++23)
  # =============================================================================
  build-macos:
    name: macOS ${{ matrix.os }} - ${{ matrix.config }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        # macos-14: Apple Silicon ARM64, macos-15: Apple Silicon ARM64
        os: [macos-14, macos-15]
        config: [Release, Debug]
        include:
          - os: macos-14
            arch: 'arm64'
            xcode_version: '15.4'
          - os: macos-15
            arch: 'arm64'
            xcode_version: '16.1'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Select Xcode version
      run: |
        # Try to select specific Xcode version, fall back to default if not available
        XCODE_PATH="/Applications/Xcode_${{ matrix.xcode_version }}.app/Contents/Developer"
        if [ -d "$XCODE_PATH" ]; then
          sudo xcode-select -s "$XCODE_PATH"
          echo "Selected Xcode ${{ matrix.xcode_version }}"
        else
          echo "Xcode ${{ matrix.xcode_version }} not found, using default Xcode"
        fi
        xcodebuild -version
        clang++ --version

    - name: Install dependencies (Homebrew)
      run: |
        brew update || true
        brew install expat cmake || brew upgrade expat cmake || true
        brew list expat || echo "expat installation check"
        
        # Set up paths for expat (Homebrew installs to /opt/homebrew on ARM, /usr/local on Intel)
        if [ -d "/opt/homebrew" ]; then
          export HOMEBREW_PREFIX="/opt/homebrew"
        else
          export HOMEBREW_PREFIX="/usr/local"
        fi
        
        # Verify expat is available and show paths
        echo "=== Expat paths ==="
        echo "HOMEBREW_PREFIX: $HOMEBREW_PREFIX"
        pkg-config --modversion expat || echo "pkg-config expat not found, using Homebrew paths"
        
        # Find expat installation
        EXPAT_PREFIX=$(brew --prefix expat 2>/dev/null || echo "$HOMEBREW_PREFIX")
        echo "Expat prefix: $EXPAT_PREFIX"
        
        # Set environment variables for CMake
        echo "EXPAT_ROOT=$EXPAT_PREFIX" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$EXPAT_PREFIX" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$EXPAT_PREFIX/lib/pkgconfig" >> $GITHUB_ENV

    - name: Configure CMake (C++23)
      run: |
        # Get expat paths
        EXPAT_PREFIX=${EXPAT_ROOT:-$(brew --prefix expat 2>/dev/null || echo "/opt/homebrew")}
        
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
          -DCMAKE_CXX_STANDARD=23 \
          -DCMAKE_CXX_STANDARD_REQUIRED=ON \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
          -DCMAKE_PREFIX_PATH="$EXPAT_PREFIX" \
          -DEXPAT_ROOT="$EXPAT_PREFIX" \
          -DCMAKE_FIND_FRAMEWORK=LAST \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH \
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=BOTH \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_EXECUTABLE=ON \
          -DBUILD_TESTING=OFF \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
          -DCMAKE_VERBOSE_MAKEFILE=ON

    - name: Build
      run: |
        # Set library paths for linker
        EXPAT_PREFIX=${EXPAT_ROOT:-$(brew --prefix expat 2>/dev/null || echo "/opt/homebrew")}
        export DYLD_LIBRARY_PATH="$EXPAT_PREFIX/lib:${DYLD_LIBRARY_PATH:-}"
        export LDFLAGS="-L$EXPAT_PREFIX/lib ${LDFLAGS:-}"
        export CPPFLAGS="-I$EXPAT_PREFIX/include ${CPPFLAGS:-}"
        
        # macOS uses single-config generator, --config may be ignored but won't hurt
        cmake --build build --config ${{ matrix.config }} --parallel $(sysctl -n hw.ncpu) 2>&1 | tee build.log || {
          echo "::error::Build failed, showing last 100 lines:"
          tail -100 build.log
          exit 1
        }
        
        # Verify libraries were built before install
        echo "=== Checking built libraries before install ==="
        echo "Searching for .dylib files:"
        find build -name "*.dylib" 2>/dev/null | head -20 || echo "No .dylib files found"
        echo "Searching for .a files:"
        find build -name "*.a" 2>/dev/null | head -20 || echo "No .a files found"
        echo "Contents of build/lib/:"
        ls -lah build/lib/ 2>/dev/null || echo "build/lib directory not found"
        echo "Checking for versioned library files:"
        ls -lah build/lib/libasterix* 2>/dev/null || echo "No libasterix files found in build/lib/"

    - name: Install
      run: |
        # Check what files exist in build/lib before install
        echo "=== Files in build/lib before install ==="
        ls -la build/lib/ 2>/dev/null || echo "build/lib not found"
        
        # Install - macOS uses single-config generator, so don't use --config
        # But try it first for compatibility
        if cmake --install build --config ${{ matrix.config }} 2>&1; then
          echo "Install completed successfully"
        else
          echo "::warning::Install with --config failed, trying without --config (single-config generator)"
          cmake --install build || {
            echo "::error::Install failed completely"
            exit 1
          }
        fi
        
        # Verify installed libraries exist (macOS)
        echo "=== Verifying installed libraries ==="
        ls -lh install/lib/ 2>/dev/null || echo "install/lib directory not found"
        echo "=== Finding all library files ==="
        find install/lib -name "*.dylib" -o -name "*.a" 2>/dev/null || echo "No libraries found"
        echo "=== Library files in install/lib ==="
        ls -la install/lib/*.dylib install/lib/*.a 2>/dev/null || echo "Library files check completed"

    - name: Test executable
      run: |
        set -e
        exe="${{ github.workspace }}/install/bin/asterix"
        if [ ! -f "$exe" ]; then
          echo "::error::Executable not found at $exe"
          find "${{ github.workspace }}" -name "asterix" -type f 2>/dev/null || true
          exit 1
        fi
        echo "Testing executable: $exe"
        "$exe" --help
        "$exe" --version
        echo "✅ macOS executable tests passed"

    - name: Run integration tests (macOS)
      run: |
        #!/bin/bash
        set -e  # Exit on error

        exe="${{ github.workspace }}/install/bin/asterix"
        config="${{ github.workspace }}/install/share/asterix/config/asterix.ini"

        echo "=== Test 1: Help ==="
        $exe --help

        echo -e "\n=== Test 2: Version ==="
        $exe --version

        echo -e "\n=== Test 3: List filters ==="
        $exe -d $config -L

        echo -e "\n✅ All macOS integration tests passed"

    - name: Verify library linkage
      run: |
        echo "=== Checking installed library files ==="
        ls -lh install/lib/*.dylib install/lib/*.a 2>/dev/null || echo "Warning: Some library files not found"
        
        echo -e "\n=== Checking executable dependencies ==="
        if [ -f "${{ github.workspace }}/install/bin/asterix" ]; then
          otool -L ${{ github.workspace }}/install/bin/asterix || echo "otool failed"
        else
          echo "Executable not found"
        fi

        echo -e "\n=== Checking library exports ==="
        if [ -f "${{ github.workspace }}/install/lib/libasterix.dylib" ]; then
          nm -gU ${{ github.workspace }}/install/lib/libasterix.dylib | head -20 || true
        else
          echo "libasterix.dylib not found, checking for .a file"
          if [ -f "${{ github.workspace }}/install/lib/libasterix.a" ]; then
            nm -g ${{ github.workspace }}/install/lib/libasterix.a | head -20 || true
          fi
        fi

    - name: Create macOS installers (macOS 15 Release only)
      if: matrix.os == 'macos-15' && matrix.config == 'Release'
      run: |
        cd build

        # Create TGZ and ZIP packages
        cpack -G TGZ
        cpack -G ZIP

        # Install create-dmg for DMG creation
        brew install create-dmg || echo "create-dmg install skipped"

        # Create DMG if create-dmg is available
        if command -v create-dmg &> /dev/null; then
          echo "Creating DMG installer..."
          cd ../install
          create-dmg \
            --volname "ASTERIX v2.8.10" \
            --volicon "../asterix/config/asterix.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "asterix" 175 120 \
            --hide-extension "asterix" \
            --app-drop-link 425 120 \
            "../build/asterix-2.8.10-macos-arm64.dmg" \
            . || echo "DMG creation skipped (icon/resources missing)"
        else
          echo "create-dmg not available - only TGZ/ZIP created"
        fi

        # Create PKG installer using macOS productbuild
        cd ../build
        if [ -d "../install" ]; then
          echo "Creating PKG installer..."
          pkgbuild --root ../install \
                   --identifier com.crocontrol.asterix \
                   --version 2.8.10 \
                   --install-location /usr/local \
                   asterix-2.8.10-macos-arm64.pkg || echo "PKG creation failed"
        fi

        # List packages
        ls -lh *.tar.gz *.zip *.dmg *.pkg 2>/dev/null || echo "Some packages not created"

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v5
      with:
        name: asterix-macos-${{ matrix.os }}-${{ matrix.config }}
        path: |
          install/bin/asterix
          install/lib/*.dylib
          install/lib/*.a
          install/include/
          asterix/config/
          build/*.tar.gz
          build/*.zip
          build/*.dmg
          build/*.pkg
          build/*.zip
        retention-days: 14

  # =============================================================================
  # LINUX BUILD (GCC 13+, C++23)
  # =============================================================================
  build-linux:
    name: Linux ${{ matrix.os }} - ${{ matrix.config }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        config: [Release, Debug]
        include:
          - os: ubuntu-22.04
            gcc_version: '11'
            cpp_standard: '17'  # GCC 11 has limited C++23 support
          - os: ubuntu-24.04
            gcc_version: '13'
            cpp_standard: '23'  # GCC 13 has full C++23 support

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install GCC ${{ matrix.gcc_version }}
      run: |
        sudo apt-get update
        if [ "${{ matrix.gcc_version }}" = "13" ]; then
          sudo apt-get install -y gcc-13 g++-13
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        fi
        gcc --version
        g++ --version

    - name: Install dependencies
      run: |
        sudo apt-get install -y \
          libexpat1-dev \
          cmake \
          ninja-build \
          lcov \
          valgrind

    - name: Configure CMake (C++${{ matrix.cpp_standard }})
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
          -DCMAKE_CXX_STANDARD=${{ matrix.cpp_standard }} \
          -DCMAKE_CXX_STANDARD_REQUIRED=ON \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_COMPILER=g++ \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_EXECUTABLE=ON \
          -DBUILD_TESTING=OFF \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install

    - name: Build
      run: |
        cmake --build build --config ${{ matrix.config }} --parallel $(nproc)

    - name: Install
      run: |
        cmake --install build --config ${{ matrix.config }}

    - name: Test executable
      run: |
        set -e
        exe="${{ github.workspace }}/install/bin/asterix"
        if [ ! -f "$exe" ]; then
          echo "::error::Executable not found at $exe"
          find "${{ github.workspace }}" -name "asterix" -type f 2>/dev/null || true
          exit 1
        fi

        # Set LD_LIBRARY_PATH for shared library
        export LD_LIBRARY_PATH="${{ github.workspace }}/install/lib:${LD_LIBRARY_PATH:-}"

        echo "Testing executable: $exe"
        "$exe" --help
        "$exe" --version
        echo "✅ Linux executable tests passed"

    - name: Run integration tests (Unix test.sh)
      if: matrix.config == 'Debug'
      run: |
        set -e

        # Build debug version with CMake for test.sh
        cmake -B build-test \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_EXECUTABLE=ON \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install
        cmake --build build-test --parallel $(nproc)
        cmake --install build-test

        # Verify test environment
        if [ ! -f "${{ github.workspace }}/install/test/test.sh" ]; then
          echo "::error::test.sh not found"
          exit 1
        fi
        if [ ! -f "${{ github.workspace }}/install/bin/asterix" ]; then
          echo "::error::asterix executable not found"
          exit 1
        fi

        # Run integration tests
        export LD_LIBRARY_PATH="${{ github.workspace }}/install/lib:${LD_LIBRARY_PATH:-}"
        cd install/test
        chmod +x ./test.sh
        ./test.sh

        echo "✅ All integration tests passed"

    - name: Run valgrind memory check (Debug only)
      if: matrix.config == 'Debug' && matrix.os == 'ubuntu-24.04'
      run: |
        echo "=== Valgrind Memory Leak Check ==="

        valgrind --leak-check=full --error-exitcode=0 \
          ${{ github.workspace }}/install/bin/asterix \
          -d ${{ github.workspace }}/asterix/config/asterix.ini \
          --help > /dev/null 2>&1 || echo "Valgrind check completed with warnings"

    - name: Verify library linkage
      run: |
        echo "=== Checking executable dependencies ==="
        ldd ${{ github.workspace }}/install/bin/asterix

        echo -e "\n=== Checking library exports ==="
        nm -D ${{ github.workspace }}/install/lib/libasterix.so | grep " T " | head -20 || true

    - name: Create DEB/RPM packages (Ubuntu 24.04 Release only)
      if: matrix.os == 'ubuntu-24.04' && matrix.config == 'Release'
      run: |
        cd build

        # Create DEB package
        cpack -G DEB

        # Create TGZ and ZIP packages
        cpack -G TGZ
        cpack -G ZIP

        ls -lh *.deb *.tar.gz *.zip || true

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v5
      with:
        name: asterix-linux-${{ matrix.os }}-${{ matrix.config }}
        path: |
          install/bin/asterix
          install/lib/*.so*
          install/lib/*.a
          install/include/
          asterix/config/
          build/*.deb
          build/*.tar.gz
          build/*.zip
        retention-days: 14

  # =============================================================================
  # LINUX ARM64 BUILD (GCC 13+, C++23)
  # Raspberry Pi, AWS Graviton, NVIDIA Jetson, DGX (ARM variants), embedded systems
  # =============================================================================
  build-linux-arm64:
    name: Linux ARM64 ${{ matrix.distro }} - ${{ matrix.config }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        distro: ['ubuntu-22.04', 'ubuntu-24.04']
        config: [Release]  # Debug build can be added if needed
        include:
          - distro: ubuntu-22.04
            tag: '22.04'
            gcc_version: '11'
            cpp_standard: '17'
          - distro: ubuntu-24.04
            tag: '24.04'
            gcc_version: '13'
            cpp_standard: '23'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up QEMU for ARM64 emulation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and test ARM64
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          arm64v8/ubuntu:${{ matrix.tag }} \
          bash -c '
            apt-get update && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              gcc-${{ matrix.gcc_version }} \
              g++-${{ matrix.gcc_version }} \
              cmake \
              ninja-build \
              libexpat1-dev && \

            gcc-${{ matrix.gcc_version }} --version && \
            g++-${{ matrix.gcc_version }} --version && \

            cmake -B build \
              -G Ninja \
              -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
              -DCMAKE_CXX_STANDARD=${{ matrix.cpp_standard }} \
              -DCMAKE_CXX_STANDARD_REQUIRED=ON \
              -DCMAKE_C_COMPILER=gcc-${{ matrix.gcc_version }} \
              -DCMAKE_CXX_COMPILER=g++-${{ matrix.gcc_version }} \
              -DBUILD_SHARED_LIBS=ON \
              -DBUILD_STATIC_LIBS=ON \
              -DBUILD_EXECUTABLE=ON \
              -DBUILD_TESTING=OFF \
              -DCMAKE_INSTALL_PREFIX=/workspace/install && \

            cmake --build build --parallel $(nproc) && \
            cmake --install build && \

            export LD_LIBRARY_PATH=/workspace/install/lib:${LD_LIBRARY_PATH:-} && \
            ./install/bin/asterix --help && \
            ./install/bin/asterix --version && \

            cd build && \
            cpack -G TGZ && \
            cpack -G DEB && \
            ls -lh *.tar.gz *.deb || true
          '

    - name: Rename ARM64 packages
      run: |
        cd build
        for file in asterix-2.8.10-*.tar.gz; do
          [ -f "$file" ] && mv "$file" "${file%.tar.gz}-arm64.tar.gz" || true
        done
        for file in asterix_2.8.10-*.deb; do
          [ -f "$file" ] && mv "$file" "${file%.deb}-arm64.deb" || true
        done
        ls -lh *arm64* || echo "No ARM64 packages found"

    - name: Upload ARM64 Linux artifacts
      uses: actions/upload-artifact@v5
      with:
        name: asterix-linux-arm64-${{ matrix.distro }}-${{ matrix.config }}
        path: |
          build/*-arm64.tar.gz
          build/*-arm64.deb
        retention-days: 14

  # =============================================================================
  # PYTHON MODULE CROSS-PLATFORM BUILD
  # =============================================================================
  build-python-module:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
        exclude:
          # Python 3.13+ not yet fully supported on Windows
          - os: windows-latest
            python-version: '3.13'
          - os: windows-latest
            python-version: '3.14'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install expat

    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    - name: Setup MSVC for Python builds (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest pytest-cov coverage memory_profiler

    - name: Build Python module (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Windows: Set environment for vcpkg and suppress D9002 warnings
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:CMAKE_TOOLCHAIN_FILE = "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        
        # Set expat include and library paths
        $env:EXPAT_INCLUDE_DIR = "$VCPKG_ROOT/installed/x64-windows/include"
        $env:EXPAT_LIB_DIR = "$VCPKG_ROOT/installed/x64-windows/lib"
        
        # Suppress MSVC D9002 warnings (unknown command-line option)
        $env:CL = "/wd9002 /W3"
        $env:_CL_ = "/wd9002 /W3"
        
        # Set distutils compiler flags
        $env:DISTUTILS_USE_SDK = "1"
        
        python setup.py build 2>&1 | ForEach-Object { 
          if ($_ -match 'D9002' -or $_ -match 'warning D9002') { 
            Write-Host "::warning::$_" 
          } else { 
            Write-Host $_ 
          } 
        }

    - name: Build Python module (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        python setup.py build

    - name: Install Python module
      run: |
        python setup.py install

    - name: Run Python tests
      run: |
        set -e

        # Check if test directory exists
        if [ ! -d "asterix/test" ]; then
          echo "::warning::asterix/test directory not found, skipping tests"
          exit 0
        fi

        # Check if there are any test files
        if ! find asterix/test -name "test_*.py" -type f | grep -q .; then
          echo "::warning::No test files found in asterix/test/, skipping tests"
          exit 0
        fi

        echo "Running Python tests..."
        python -m pytest asterix/test/ -v --cov=asterix --cov-report=xml
        echo "✅ Python tests passed"

    - name: Upload Python coverage
      if: false  # Disabled until tests pass
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: python-${{ runner.os }}
        name: python-${{ matrix.python-version }}-${{ runner.os }}

  # =============================================================================
  # BUILD VERIFICATION SUMMARY
  # =============================================================================
  build-summary:
    name: Cross-Platform Build Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux, build-linux-arm64, build-python-module]
    if: always()

    steps:
    - name: Check build results
      run: |
        echo "=========================================="
        echo "   CROSS-PLATFORM BUILD SUMMARY"
        echo "=========================================="
        echo ""
        echo "Windows builds:  ${{ needs.build-windows.result }}"
        echo "macOS builds:     ${{ needs.build-macos.result }}"
        echo "Linux x86_64:     ${{ needs.build-linux.result }}"
        echo "Linux ARM64:      ${{ needs.build-linux-arm64.result }}"
        echo "Python modules:   ${{ needs.build-python-module.result }}"
        echo ""

        if [[ "${{ needs.build-windows.result }}" == "success" ]] && \
           [[ "${{ needs.build-macos.result }}" == "success" ]] && \
           [[ "${{ needs.build-linux-arm64.result }}" == "success" ]] && \
           [[ "${{ needs.build-linux.result }}" == "success" ]]; then
          echo "✅ All platform builds successful!"
          exit 0
        else
          echo "⚠️  Some builds failed or were skipped"
          exit 1
        fi

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        path: artifacts/

    - name: Display artifact summary
      run: |
        echo ""
        echo "=========================================="
        echo "   BUILD ARTIFACTS SUMMARY"
        echo "=========================================="
        find artifacts/ -type f -exec ls -lh {} \; | head -50
