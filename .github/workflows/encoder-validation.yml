name: Encoder Validation

on:
  push:
    branches: [ master, develop, 'feature/**', 'radar/**' ]
    paths:
      - 'asterix/radar_integration/encoder/**'
      - 'asterix/radar_integration/test/test_encoder.py'
      - 'scripts/ci/test_*.py'
      - '.github/workflows/encoder-validation.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'asterix/radar_integration/encoder/**'
      - 'asterix/radar_integration/test/test_encoder.py'
      - 'scripts/ci/test_*.py'
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  # =============================================================================
  # ROUND-TRIP ENCODING/DECODING TESTS
  # =============================================================================
  round-trip-tests:
    name: Round-Trip Encoding/Decoding Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest pytest-cov

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Run encoder round-trip tests (pytest)
      run: |
        python -m pytest asterix/radar_integration/test/test_encoder.py -v -k "round_trip" || true

    - name: Test CAT048 round-trip encoding
      run: python scripts/ci/test_cat048_roundtrip.py

  # =============================================================================
  # BINARY FORMAT VALIDATION
  # =============================================================================
  binary-format-validation:
    name: Binary Format Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Validate CAT048 binary format structure
      run: python scripts/ci/test_cat048_binary_format.py

  # =============================================================================
  # ENCODER EDGE CASE TESTS
  # =============================================================================
  edge-case-tests:
    name: Encoder Edge Case Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Run encoder edge case tests
      run: python scripts/ci/test_encoder_edge_cases.py

  # =============================================================================
  # VALIDATION SUMMARY
  # =============================================================================
  encoder-validation-summary:
    name: Encoder Validation Summary
    runs-on: ubuntu-latest
    needs: [round-trip-tests, binary-format-validation, edge-case-tests]
    if: always()

    steps:
    - name: Check validation results
      run: |
        echo "=========================================="
        echo "   ENCODER VALIDATION SUMMARY"
        echo "=========================================="
        echo ""
        echo "Round-trip tests:    ${{ needs.round-trip-tests.result }}"
        echo "Binary format:       ${{ needs.binary-format-validation.result }}"
        echo "Edge case tests:     ${{ needs.edge-case-tests.result }}"
        echo ""

        if [[ "${{ needs.round-trip-tests.result }}" == "success" ]] && \
           [[ "${{ needs.binary-format-validation.result }}" == "success" ]] && \
           [[ "${{ needs.edge-case-tests.result }}" == "success" ]]; then
          echo "✅ All encoder validations passed!"
          exit 0
        else
          echo "⚠️  Some encoder validations failed"
          exit 1
        fi
