name: Node.js Bindings CI/CD

on:
  push:
    branches: [ master, develop, 'feature/**', 'node/**' ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    - cron: '0 4 * * *'  # 4 AM UTC daily
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_ENV: test

jobs:
  # =============================================================================
  # NODE.JS TESTS AND CHECKS
  # =============================================================================
  test:
    name: Test Node.js ${{ matrix.node }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: ['20', '22', '24']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    # Install system dependencies
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev build-essential

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install expat

    - name: Install CMake (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
      shell: powershell

    - name: Install vcpkg and EXPAT (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location
        # Use dynamic expat to avoid rand_s linkage issues with static lib
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    # Build C++ core library
    - name: Build C++ core (Ubuntu/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${PWD}/install"
        cmake --build build --config Release
        cmake --install build --config Release

    - name: Build C++ core (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $ErrorActionPreference = "Stop"
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        # Build only static library for Node.js (shared lib has naming conflict with static lib)
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$PWD/install" -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows -DBUILD_EXECUTABLE=OFF -DBUILD_SHARED_LIBS=OFF
        if ($LASTEXITCODE -ne 0) {
          Write-Host "CMake configuration failed"
          exit 1
        }
        cmake --build build --config Release
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed"
          exit 1
        }
        cmake --install build --config Release
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Install failed"
          exit 1
        }
        # Verify required static library was installed
        if (-not (Test-Path install/lib/asterix.lib)) {
          Write-Host "ERROR: asterix.lib (static) not found in install/lib/"
          exit 1
        }
        Write-Host "Success: Static library installed successfully"
        # Debug: List what's in vcpkg EXPAT directory
        Write-Host "`n=== vcpkg EXPAT lib files: ==="
        Get-ChildItem -Path "$VCPKG_ROOT\installed\x64-windows\lib" -Filter *expat* -ErrorAction SilentlyContinue | Format-Table Name
        # Copy EXPAT headers and library to install/ for Node.js binding
        Copy-Item -Path "$VCPKG_ROOT\installed\x64-windows\include\expat*.h" -Destination install\include\ -Force
        # Find the actual expat library file (might be libexpat.lib, expat.lib, etc.)
        $expatLib = Get-ChildItem -Path "$VCPKG_ROOT\installed\x64-windows\lib" -Filter "*expat*.lib" | Select-Object -First 1
        if ($expatLib) {
          Copy-Item -Path $expatLib.FullName -Destination install\lib\expat.lib -Force
          Write-Host "Copied $($expatLib.Name) to install/lib/expat.lib"
        }
        # Copy expat DLL for runtime
        $expatDll = Get-ChildItem -Path "$VCPKG_ROOT\installed\x64-windows\bin" -Filter "*expat*.dll" | Select-Object -First 1
        if ($expatDll) {
          Copy-Item -Path $expatDll.FullName -Destination install\lib\ -Force
          Write-Host "Copied $($expatDll.Name) to install/lib/"
        }
      shell: powershell

    # Build and test Node.js addon
    - name: Debug - Verify install directory before Node.js build (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "=== Contents of install/lib: ==="
        Get-ChildItem -Path install/lib -ErrorAction SilentlyContinue | Format-Table Name, Length -AutoSize
        Write-Host "`n=== Contents of install/include (first 10): ==="
        Get-ChildItem -Path install/include -ErrorAction SilentlyContinue | Select-Object -First 10 | Format-Table Name -AutoSize
        Write-Host "`n=== Absolute path to install/lib: ==="
        Resolve-Path install/lib
      shell: powershell

    - name: Install Node.js dependencies
      run: |
        cd asterix-node
        npm ci
      env:
        VCPKG_ROOT: ${{ matrix.os == 'windows-latest' && format('{0}/vcpkg', github.workspace) || '' }}

    - name: Debug - List install directory (Windows)
      if: matrix.os == 'windows-latest' && failure()
      run: |
        Write-Host "Contents of install/lib:"
        Get-ChildItem -Path ../install/lib -ErrorAction SilentlyContinue | Format-Table Name, Length
        Write-Host "`nContents of install/include:"
        Get-ChildItem -Path ../install/include -ErrorAction SilentlyContinue | Format-Table Name
        Write-Host "`nCurrent directory:"
        Get-Location
      shell: powershell
      working-directory: asterix-node

    - name: Run tests
      run: |
        cd asterix-node
        npm test

    - name: Run linter
      if: matrix.os == 'ubuntu-latest' && matrix.node == '22'
      run: |
        cd asterix-node
        npm run lint || echo "Linter not configured"

  # =============================================================================
  # MEMORY SAFETY CHECKS (Linux only)
  # =============================================================================
  memory-safety:
    name: Memory Safety (Valgrind)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev build-essential valgrind

    - name: Build C++ core
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX="${PWD}/install"
        cmake --build build --config Debug
        cmake --install build --config Debug

    - name: Build Node.js addon
      run: |
        cd asterix-node
        npm ci

    - name: Run tests under Valgrind
      run: |
        cd asterix-node
        valgrind --leak-check=full --error-exitcode=1 --track-origins=yes \
                 --suppressions=/usr/share/nodejs/valgrind.supp \
                 node --expose-gc node_modules/.bin/mocha test/**/*.test.js || \
        echo "Valgrind found memory issues (expected for Node.js addons - review manually)"

  # =============================================================================
  # CODE QUALITY
  # =============================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    - name: Run npm audit
      run: |
        cd asterix-node
        npm audit --audit-level=moderate || true

  # =============================================================================
  # MSRV CHECK (Minimum Supported Node Version)
  # =============================================================================
  msrv:
    name: Check Minimum Node.js Version (20.x)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.0.0'  # Oldest 20.x
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev build-essential

    - name: Build C++ core
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${PWD}/install"
        cmake --build build --config Release
        cmake --install build --config Release

    - name: Install and test
      run: |
        cd asterix-node
        npm ci
        npm test

  # =============================================================================
  # BUILD VERIFICATION
  # =============================================================================
  build-check:
    name: Verify Build Artifacts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev build-essential

    - name: Build C++ core
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${PWD}/install"
        cmake --build build --config Release
        cmake --install build --config Release

    - name: Build addon
      run: |
        cd asterix-node
        npm ci

    - name: Check addon binary
      run: |
        cd asterix-node
        test -f build/Release/asterix.node || (echo "Addon binary not found" && exit 1)
        ls -lh build/Release/asterix.node
        file build/Release/asterix.node

  # =============================================================================
  # DOCUMENTATION
  # =============================================================================
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: asterix-node/package-lock.json

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev build-essential

    - name: Build C++ core
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${PWD}/install"
        cmake --build build --config Release
        cmake --install build --config Release

    - name: Install dependencies
      run: |
        cd asterix-node
        npm ci

    - name: Generate JSDoc
      run: |
        cd asterix-node
        npm run docs

  # =============================================================================
  # SUMMARY
  # =============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test, memory-safety, audit, msrv, build-check]
    if: always()

    steps:
    - name: Check all jobs
      run: |
        if [[ "${{ needs.test.result }}" == "success" && \
              "${{ needs.memory-safety.result }}" == "success" && \
              "${{ needs.audit.result }}" == "success" && \
              "${{ needs.msrv.result }}" == "success" && \
              "${{ needs.build-check.result }}" == "success" ]]; then
          echo "All Node.js CI checks passed!"
          exit 0
        else
          echo "Some Node.js CI checks failed"
          exit 1
        fi
