name: Performance Benchmarks

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      compare_baseline:
        description: 'Compare against baseline commit (SHA or tag)'
        required: false
        type: string

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  # =============================================================================
  # ENCODER PERFORMANCE BENCHMARKS
  # =============================================================================
  encoder-benchmarks:
    name: Encoder Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest pytest-benchmark

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Run encoder benchmarks
      run: python scripts/ci/benchmark_encoder.py

    - name: Upload encoder benchmark results
      uses: actions/upload-artifact@v5
      with:
        name: encoder-benchmarks
        path: encoder_benchmark_results.txt
        retention-days: 90

  # =============================================================================
  # MOCK RADAR PERFORMANCE BENCHMARKS
  # =============================================================================
  mock-radar-benchmarks:
    name: Mock Radar Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest-benchmark

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Run mock radar benchmarks
      run: python scripts/ci/benchmark_mock_radar.py

    - name: Upload mock radar benchmark results
      uses: actions/upload-artifact@v5
      with:
        name: mock-radar-benchmarks
        path: mock_radar_benchmark_results.txt
        retention-days: 90

  # =============================================================================
  # BENCHMARK SUMMARY
  # =============================================================================
  benchmark-summary:
    name: Performance Benchmark Summary
    runs-on: ubuntu-latest
    needs: [encoder-benchmarks, mock-radar-benchmarks]
    if: always()

    steps:
    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        path: all-benchmarks/

    - name: Generate benchmark report
      run: |
        echo "=========================================="
        echo "   PERFORMANCE BENCHMARK SUMMARY"
        echo "=========================================="
        echo ""

        if [ -f "all-benchmarks/encoder-benchmarks/encoder_benchmark_results.txt" ]; then
          echo "=== Encoder Benchmarks ==="
          cat all-benchmarks/encoder-benchmarks/encoder_benchmark_results.txt
          echo ""
        fi

        if [ -f "all-benchmarks/mock-radar-benchmarks/mock_radar_benchmark_results.txt" ]; then
          echo "=== Mock Radar Benchmarks ==="
          cat all-benchmarks/mock-radar-benchmarks/mock_radar_benchmark_results.txt
          echo ""
        fi

        echo "=========================================="
        echo "âœ… All benchmarks completed"

    - name: Upload consolidated benchmark report
      uses: actions/upload-artifact@v5
      with:
        name: performance-benchmarks-all
        path: all-benchmarks/
        retention-days: 90
