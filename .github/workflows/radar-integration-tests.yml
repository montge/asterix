name: Radar Integration Tests

on:
  push:
    branches: [ master, develop, 'feature/**', 'radar/**' ]
    paths:
      - 'asterix/radar_integration/**'
      - 'examples/radar_integration/**'
      - '.github/workflows/radar-integration-tests.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'asterix/radar_integration/**'
      - 'examples/radar_integration/**'
      - '.github/workflows/radar-integration-tests.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  # Coverage target for new radar integration code
  COVERAGE_TARGET: 80

jobs:
  # =============================================================================
  # RADAR INTEGRATION TESTS (Cross-platform, Python 3.10-3.13)
  # =============================================================================
  test-radar-integration:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12', '3.13']
        include:
          # Enable visualization tests only on one Ubuntu job to save CI time
          - os: ubuntu-latest
            python-version: '3.12'
            test-visualization: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update || true
        brew install expat || brew upgrade expat || true

    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location

    - name: Install system dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    - name: Install Python dependencies (core)
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest pytest-cov

    - name: Install Python dependencies (visualization)
      if: matrix.test-visualization == true
      run: |
        pip install matplotlib

    - name: Build ASTERIX Python module (Unix)
      if: runner.os != 'Windows'
      run: |
        pip install .

    - name: Build ASTERIX Python module (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        Write-Host "VCPKG_ROOT: $env:VCPKG_ROOT"
        Write-Host "Checking for expat..."
        $expatInclude = Join-Path $env:VCPKG_ROOT "installed/x64-windows/include"
        $expatLib = Join-Path $env:VCPKG_ROOT "installed/x64-windows/lib"
        $expatBin = Join-Path $env:VCPKG_ROOT "installed/x64-windows/bin"
        if (Test-Path $expatInclude) {
          Write-Host "Found expat include: $expatInclude"
          $env:EXPAT_INCLUDE_DIR = $expatInclude
        }
        if (Test-Path $expatLib) {
          Write-Host "Found expat lib: $expatLib"
          $env:EXPAT_LIB_DIR = $expatLib
        }
        pip install .
        # Add vcpkg bin to PATH for runtime DLL loading (takes effect in next steps)
        if (Test-Path $expatBin) {
          Write-Host "Adding vcpkg bin to PATH: $expatBin"
          Add-Content $env:GITHUB_PATH $expatBin
          # Also copy DLL to Python site-packages for immediate availability
          $pythonSitePackages = python -c "import site; print(site.getsitepackages()[0])"
          Write-Host "Python site-packages: $pythonSitePackages"
          Get-ChildItem "$expatBin\*.dll" | ForEach-Object {
            Write-Host "Copying $($_.Name) to $pythonSitePackages"
            Copy-Item $_.FullName -Destination $pythonSitePackages -Force
          }
        }

    - name: Verify radar_integration module exists (Unix)
      if: runner.os != 'Windows'
      run: |
        python -c "import asterix.radar_integration; print('radar_integration module loaded successfully')"

    - name: Verify radar_integration module exists (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        python -c "import asterix.radar_integration; print('radar_integration module loaded successfully')"

    - name: Run radar integration unit tests
      run: |
        python -m pytest asterix/radar_integration/test/ -v --cov=asterix.radar_integration --cov-report=xml --cov-report=html --cov-report=term

    - name: Check test coverage threshold
      if: runner.os == 'Linux' && matrix.python-version == '3.12'
      run: |
        # Extract coverage percentage from pytest output
        coverage report --fail-under=${{ env.COVERAGE_TARGET }} || {
          echo "::warning::Coverage is below ${{ env.COVERAGE_TARGET }}% threshold"
          exit 0  # Don't fail on coverage for now
        }

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5.5.1
      with:
        files: ./coverage.xml
        flags: radar-integration,python-${{ matrix.python-version }}
        name: radar-integration-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false
      continue-on-error: true

    - name: Upload HTML coverage report
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: coverage-html-${{ matrix.os }}-py${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 7

  # =============================================================================
  # EXAMPLE VALIDATION (Test all examples run without errors)
  # =============================================================================
  test-examples:
    name: Test Examples on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.12']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy matplotlib

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Test basic_mock_radar.py
      run: |
        python examples/radar_integration/basic_mock_radar.py
      timeout-minutes: 2

    - name: Test encode_and_decode.py
      run: |
        python examples/radar_integration/encode_and_decode.py
      timeout-minutes: 2

    - name: Test aircraft_scenario.py
      run: |
        python examples/radar_integration/aircraft_scenario.py
      timeout-minutes: 2

    - name: Test full_pipeline.py
      run: |
        python examples/radar_integration/full_pipeline.py
      timeout-minutes: 2

    - name: Test visualization_demo.py (headless)
      run: |
        # Run in headless mode (no display required)
        python examples/radar_integration/visualization_demo.py
      timeout-minutes: 2
      env:
        MPLBACKEND: Agg  # Use non-interactive matplotlib backend

    - name: Verify all examples are syntactically valid
      run: |
        python -m py_compile examples/radar_integration/*.py

  # =============================================================================
  # ENCODER SMOKE TESTS (Quick validation of all encoders)
  # =============================================================================
  encoder-smoke-test:
    name: Encoder Smoke Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest

    - name: Build ASTERIX Python module
      run: |
        pip install .

    - name: Test all encoders are importable
      run: |
        python -c "from asterix.radar_integration.encoder import cat048; print('CAT048 encoder loaded')"
        # Add more encoders as they are implemented:
        # python -c "from asterix.radar_integration.encoder import cat062; print('CAT062 encoder loaded')"
        # python -c "from asterix.radar_integration.encoder import cat021; print('CAT021 encoder loaded')"

    - name: Quick encoder functionality test
      run: |
        python3 << 'PYTHON_SCRIPT'
        from asterix.radar_integration.encoder.cat048 import encode_cat048_record, encode_cat048_datablock

        # Create a single CAT048 record
        record = encode_cat048_record(
            range_m=10000.0,
            azimuth_deg=45.0,
            sac=1,
            sic=2,
            mode3a=0o1234
        )
        print(f'Encoded CAT048 record: {len(record)} bytes')
        assert len(record) > 0, 'Record encoding failed'

        # Create a complete data block with the record
        datablock = encode_cat048_datablock([record])
        print(f'Encoded CAT048 datablock: {len(datablock)} bytes')
        assert len(datablock) > 0, 'Datablock encoding failed'
        assert datablock[0] == 48, 'Category must be 48'

        print('CAT048 encoder smoke test passed')
        PYTHON_SCRIPT

  # =============================================================================
  # TEST SUMMARY
  # =============================================================================
  radar-integration-summary:
    name: Radar Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-radar-integration, test-examples, encoder-smoke-test]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "=========================================="
        echo "   RADAR INTEGRATION TEST SUMMARY"
        echo "=========================================="
        echo ""
        echo "Unit tests:       ${{ needs.test-radar-integration.result }}"
        echo "Example tests:    ${{ needs.test-examples.result }}"
        echo "Encoder tests:    ${{ needs.encoder-smoke-test.result }}"
        echo ""

        if [[ "${{ needs.test-radar-integration.result }}" == "success" ]] && \
           [[ "${{ needs.test-examples.result }}" == "success" ]] && \
           [[ "${{ needs.encoder-smoke-test.result }}" == "success" ]]; then
          echo "✅ All radar integration tests passed!"
          exit 0
        else
          echo "⚠️  Some radar integration tests failed"
          exit 1
        fi
