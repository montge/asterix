name: Radar Integration Tests

on:
  push:
    branches: [ master, develop, 'feature/**', 'radar/**' ]
    paths:
      - 'asterix/radar_integration/**'
      - 'examples/radar_integration/**'
      - '.github/workflows/radar-integration-tests.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'asterix/radar_integration/**'
      - 'examples/radar_integration/**'
      - '.github/workflows/radar-integration-tests.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  # Coverage target for new radar integration code
  COVERAGE_TARGET: 80

jobs:
  # =============================================================================
  # RADAR INTEGRATION TESTS (Cross-platform, Python 3.10-3.13)
  # =============================================================================
  test-radar-integration:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12', '3.13']
        include:
          # Enable visualization tests only on one Ubuntu job to save CI time
          - os: ubuntu-latest
            python-version: '3.12'
            test-visualization: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update || true
        brew install expat || brew upgrade expat || true

    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location

    - name: Install system dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    - name: Install Python dependencies (core)
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest pytest-cov

    - name: Install Python dependencies (visualization)
      if: matrix.test-visualization == true
      run: |
        pip install matplotlib

    - name: Build ASTERIX Python module
      run: |
        python setup.py build
        python setup.py install

    - name: Verify radar_integration module exists
      run: |
        python -c "import asterix.radar_integration; print('radar_integration module loaded successfully')"

    - name: Run radar integration unit tests
      run: |
        python -m pytest asterix/radar_integration/test/ -v --cov=asterix.radar_integration --cov-report=xml --cov-report=html --cov-report=term

    - name: Check test coverage threshold
      if: runner.os == 'Linux' && matrix.python-version == '3.12'
      run: |
        # Extract coverage percentage from pytest output
        coverage report --fail-under=${{ env.COVERAGE_TARGET }} || {
          echo "::warning::Coverage is below ${{ env.COVERAGE_TARGET }}% threshold"
          exit 0  # Don't fail on coverage for now
        }

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5.5.1
      with:
        files: ./coverage.xml
        flags: radar-integration,python-${{ matrix.python-version }}
        name: radar-integration-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false
      continue-on-error: true

    - name: Upload HTML coverage report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: coverage-html-${{ matrix.os }}-py${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 7

  # =============================================================================
  # EXAMPLE VALIDATION (Test all examples run without errors)
  # =============================================================================
  test-examples:
    name: Test Examples on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.12']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy matplotlib

    - name: Build ASTERIX Python module
      run: |
        python setup.py build
        python setup.py install

    - name: Test basic_mock_radar.py
      run: |
        python examples/radar_integration/basic_mock_radar.py
      timeout-minutes: 2

    - name: Test encode_and_decode.py
      run: |
        python examples/radar_integration/encode_and_decode.py
      timeout-minutes: 2

    - name: Test aircraft_scenario.py
      run: |
        python examples/radar_integration/aircraft_scenario.py
      timeout-minutes: 2

    - name: Test full_pipeline.py
      run: |
        python examples/radar_integration/full_pipeline.py
      timeout-minutes: 2

    - name: Test visualization_demo.py (headless)
      run: |
        # Run in headless mode (no display required)
        python examples/radar_integration/visualization_demo.py
      timeout-minutes: 2
      env:
        MPLBACKEND: Agg  # Use non-interactive matplotlib backend

    - name: Verify all examples are syntactically valid
      run: |
        python -m py_compile examples/radar_integration/*.py

  # =============================================================================
  # ENCODER SMOKE TESTS (Quick validation of all encoders)
  # =============================================================================
  encoder-smoke-test:
    name: Encoder Smoke Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install numpy scipy pytest

    - name: Build ASTERIX Python module
      run: |
        python setup.py build
        python setup.py install

    - name: Test all encoders are importable
      run: |
        python -c "from asterix.radar_integration.encoder import cat048; print('CAT048 encoder loaded')"
        # Add more encoders as they are implemented:
        # python -c "from asterix.radar_integration.encoder import cat062; print('CAT062 encoder loaded')"
        # python -c "from asterix.radar_integration.encoder import cat021; print('CAT021 encoder loaded')"

    - name: Quick encoder functionality test
      run: |
        python3 << 'PYTHON_SCRIPT'
        from asterix.radar_integration.encoder.cat048 import encode_cat048_plot

        # Create a minimal valid plot
        plot = {
            'sac': 1,
            'sic': 2,
            'time_of_day': 3600.5,
            'polar_coords': {
                'rho': 10000.0,
                'theta': 45.0
            },
            'mode_3a_code': 0o1234,
            'flight_level': 350.0,
            'radar_plot_characteristics': 0x01
        }

        data = encode_cat048_plot(plot)
        print(f'Encoded CAT048 plot: {len(data)} bytes')
        assert len(data) > 0, 'Encoding failed'
        print('CAT048 encoder smoke test passed')
        PYTHON_SCRIPT

  # =============================================================================
  # TEST SUMMARY
  # =============================================================================
  radar-integration-summary:
    name: Radar Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-radar-integration, test-examples, encoder-smoke-test]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "=========================================="
        echo "   RADAR INTEGRATION TEST SUMMARY"
        echo "=========================================="
        echo ""
        echo "Unit tests:       ${{ needs.test-radar-integration.result }}"
        echo "Example tests:    ${{ needs.test-examples.result }}"
        echo "Encoder tests:    ${{ needs.encoder-smoke-test.result }}"
        echo ""

        if [[ "${{ needs.test-radar-integration.result }}" == "success" ]] && \
           [[ "${{ needs.test-examples.result }}" == "success" ]] && \
           [[ "${{ needs.encoder-smoke-test.result }}" == "success" ]]; then
          echo "✅ All radar integration tests passed!"
          exit 0
        else
          echo "⚠️  Some radar integration tests failed"
          exit 1
        fi
