name: Rust Bindings CI/CD

on:
  push:
    branches: [ master, develop, 'feature/**', 'rust/**' ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =============================================================================
  # RUST TESTS AND CHECKS
  # =============================================================================
  test:
    name: Test Rust ${{ matrix.rust }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, nightly]
        exclude:
          # Reduce test matrix - only test nightly on Linux
          - os: macos-latest
            rust: nightly
          - os: windows-latest
            rust: nightly

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache Cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: Cache Cargo build
      uses: actions/cache@v4
      with:
        path: asterix-rs/target
        key: ${{ runner.os }}-cargo-build-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-${{ matrix.rust }}-

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install expat

    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        if (-not (Test-Path $VCPKG_ROOT)) {
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        }
        Push-Location $VCPKG_ROOT
        & .\bootstrap-vcpkg.bat
        Pop-Location

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        & "$VCPKG_ROOT/vcpkg.exe" install expat:x64-windows
        & "$VCPKG_ROOT/vcpkg.exe" integrate install

    - name: Build Rust crate
      run: |
        cd asterix-rs
        cargo build --verbose --all-features
      env:
        CMAKE_TOOLCHAIN_FILE: ${{ runner.os == 'Windows' && format('{0}/vcpkg/scripts/buildsystems/vcpkg.cmake', github.workspace) || '' }}
        VCPKG_ROOT: ${{ runner.os == 'Windows' && format('{0}/vcpkg', github.workspace) || '' }}

    - name: Run tests
      shell: bash
      run: |
        cd asterix-rs
        # Check if Cargo.toml exists
        if [ ! -f "Cargo.toml" ]; then
          echo "Error: Cargo.toml not found in asterix-rs/"
          exit 1
        fi
        # Run tests with better error reporting
        # Note: --test-threads=1 works around global state SIGSEGV issue (temporary)
        cargo test --verbose --all-features -- --test-threads=1 || {
          echo "::error::Rust tests failed"
          exit 1
        }
      env:
        CMAKE_TOOLCHAIN_FILE: ${{ runner.os == 'Windows' && format('{0}/vcpkg/scripts/buildsystems/vcpkg.cmake', github.workspace) || '' }}
        VCPKG_ROOT: ${{ runner.os == 'Windows' && format('{0}/vcpkg', github.workspace) || '' }}
      continue-on-error: ${{ matrix.rust == 'nightly' }}

    - name: Run clippy (strict)
      run: |
        cd asterix-rs
        cargo clippy --all-features --all-targets -- -D warnings
      continue-on-error: ${{ matrix.rust == 'nightly' }}

    - name: Check formatting
      run: |
        cd asterix-rs
        cargo fmt -- --check
      continue-on-error: ${{ matrix.rust == 'nightly' }}

  # =============================================================================
  # QUALITY CHECKS
  # =============================================================================
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Check formatting
      run: |
        cd asterix-rs
        cargo fmt -- --check

    - name: Run clippy (all warnings as errors)
      run: |
        cd asterix-rs
        cargo clippy --all-features --all-targets -- -D warnings

    - name: Build documentation
      run: |
        cd asterix-rs
        cargo doc --all-features --no-deps
      env:
        RUSTDOCFLAGS: "--deny warnings"

    - name: Check for outdated dependencies
      run: |
        cd asterix-rs
        cargo install cargo-outdated --locked || true
        cargo outdated --exit-code 1 || echo "⚠️  Some dependencies are outdated"
      continue-on-error: true

    - name: Security audit
      run: |
        cd asterix-rs
        cargo install cargo-audit --locked || true
        cargo audit
      continue-on-error: true

    - name: Check unused dependencies
      run: |
        cd asterix-rs
        cargo install cargo-udeps --locked || true
        cargo +nightly udeps --all-targets
      continue-on-error: true

  # =============================================================================
  # CODE COVERAGE (TARPAULIN)
  # =============================================================================
  coverage-tarpaulin:
    name: Code Coverage (Tarpaulin)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install cargo-tarpaulin
      uses: taiki-e/install-action@cargo-tarpaulin

    - name: Generate coverage with tarpaulin
      run: |
        cd asterix-rs
        cargo tarpaulin \
          --verbose \
          --all-features \
          --workspace \
          --timeout 300 \
          --engine llvm \
          --out Xml \
          --out Html \
          --out Json \
          --out Lcov \
          --output-dir coverage \
          --fail-under 75 \
          -- --test-threads=1

    - name: Check coverage thresholds
      run: |
        cd asterix-rs
        echo "=== Coverage Thresholds ==="
        echo "Target: 80% per module, 90% overall"
        echo ""

        # Parse coverage from JSON
        if [ -f coverage/tarpaulin-report.json ]; then
          COVERAGE=$(python3 -c "import json; data=json.load(open('coverage/tarpaulin-report.json')); print(f'{data.get(\"coverage\", 0):.2f}')" 2>/dev/null || echo "0")
          echo "Overall coverage: ${COVERAGE}%"

          # Check if coverage meets 80% minimum threshold
          if (( $(echo "$COVERAGE < 75" | bc -l) )); then
            echo "❌ FAILED: Coverage ${COVERAGE}% is below 75% minimum threshold"
            exit 1
          elif (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "⚠️  WARNING: Coverage ${COVERAGE}% is below 80% target (meets 75% minimum)"
          else
            echo "✅ PASSED: Coverage ${COVERAGE}% meets 90% target"
          fi
        else
          echo "⚠️  Could not parse coverage results"
        fi
      continue-on-error: false

    - name: Upload coverage reports
      uses: actions/upload-artifact@v5
      with:
        name: coverage-tarpaulin-reports
        path: |
          asterix-rs/coverage/
        retention-days: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./asterix-rs/coverage/cobertura.xml
        flags: rust,tarpaulin
        name: rust-coverage-tarpaulin
        fail_ci_if_error: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # =============================================================================
  # CODE COVERAGE (LLVM-COV) - Alternative coverage tool
  # =============================================================================
  coverage-llvm-cov:
    name: Code Coverage (llvm-cov)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable with llvm-tools
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate coverage with llvm-cov
      run: |
        cd asterix-rs
        # Create output directory for coverage reports
        mkdir -p coverage-llvm/html
        # Note: --test-threads=1 works around global state SIGSEGV issue (temporary)
        cargo llvm-cov \
          --all-features \
          --workspace \
          --lcov \
          --output-path coverage-llvm/lcov.info \
          -- --test-threads=1

        cargo llvm-cov report \
          --html \
          --output-dir coverage-llvm/html

        cargo llvm-cov report \
          --json \
          --output-path coverage-llvm/coverage.json

    - name: Check llvm-cov coverage thresholds
      run: |
        cd asterix-rs
        echo "=== LLVM-COV Coverage Analysis ==="

        # Extract coverage percentage from JSON
        if [ -f coverage-llvm/coverage.json ]; then
          COVERAGE=$(python3 -c "import json; data=json.load(open('coverage-llvm/coverage.json')); print(f'{data[\"data\"][0][\"totals\"][\"lines\"][\"percent\"]:.2f}')" 2>/dev/null || echo "0")
          echo "Overall line coverage: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < 75" | bc -l) )); then
            echo "❌ FAILED: Coverage ${COVERAGE}% is below 75% minimum threshold"
            exit 1
          elif (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "⚠️  WARNING: Coverage ${COVERAGE}% is below 80% target (meets 75% minimum)"
          else
            echo "✅ PASSED: Coverage ${COVERAGE}% meets 90% target"
          fi
        fi
      continue-on-error: false

    - name: Upload llvm-cov reports
      uses: actions/upload-artifact@v5
      with:
        name: coverage-llvm-cov-reports
        path: |
          asterix-rs/coverage-llvm/
        retention-days: 30

    - name: Upload llvm-cov to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./asterix-rs/coverage-llvm/lcov.info
        flags: rust,llvm-cov
        name: rust-coverage-llvm-cov
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # =============================================================================
  # BENCHMARKS
  # =============================================================================
  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Run benchmarks
      run: |
        cd asterix-rs
        cargo bench --all-features -- --output-format bencher | tee benchmark-results.txt
      continue-on-error: true

    - name: Store benchmark results
      uses: actions/upload-artifact@v5
      with:
        name: benchmark-results
        path: asterix-rs/benchmark-results.txt
        retention-days: 30
      continue-on-error: true

  # =============================================================================
  # SECURITY AUDIT
  # =============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-deny
      run: cargo install cargo-deny

    - name: Run cargo-audit (vulnerability scanning)
      uses: rustsec/audit-check@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        working-directory: asterix-rs
      continue-on-error: true

    - name: Run cargo-deny (advisories check)
      run: |
        cd asterix-rs
        cargo deny check advisories
      continue-on-error: false

    - name: Run cargo-deny (license check)
      run: |
        cd asterix-rs
        cargo deny check licenses
      continue-on-error: false

    - name: Run cargo-deny (bans check)
      run: |
        cd asterix-rs
        cargo deny check bans
      continue-on-error: true

    - name: Run cargo-deny (sources check)
      run: |
        cd asterix-rs
        cargo deny check sources
      continue-on-error: true

  # =============================================================================
  # MEMORY SAFETY CHECKS
  # =============================================================================
  memory-safety:
    name: Memory Safety (Valgrind)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev valgrind

    - name: Build in debug mode
      run: |
        cd asterix-rs
        cargo build --verbose

    - name: Run tests under valgrind
      run: |
        cd asterix-rs
        cargo test --no-run

        # Find test binary
        TEST_BINARY=$(find target/debug/deps -name 'integration_test-*' -type f -executable | head -1)

        if [ -n "$TEST_BINARY" ]; then
          echo "Running valgrind on $TEST_BINARY"
          valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --error-exitcode=1 \
            "$TEST_BINARY" --test-threads=1 || echo "Valgrind found issues"
        fi
      continue-on-error: true

  # =============================================================================
  # BUILD DOCUMENTATION
  # =============================================================================
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Build documentation
      run: |
        cd asterix-rs
        cargo doc --all-features --no-deps
      env:
        RUSTDOCFLAGS: "--deny warnings"
      continue-on-error: false

    - name: Upload documentation
      uses: actions/upload-artifact@v5
      with:
        name: rust-docs
        path: asterix-rs/target/doc
        retention-days: 14
      continue-on-error: true

  # =============================================================================
  # CROSS-PLATFORM BUILD VERIFICATION
  # =============================================================================
  cross-compile:
    name: Cross-compile ${{ matrix.target }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          # macOS targets removed - cross doesn't support Darwin targets
          # macOS builds are already tested in the 'test' job on macos-latest
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Build for target
      run: |
        # Run cross from repo root so it mounts the entire project including ../src/
        # Use --manifest-path to specify the crate to build
        cross build --manifest-path asterix-rs/Cargo.toml --target ${{ matrix.target }} --verbose
      continue-on-error: false

  # =============================================================================
  # MINIMUM SUPPORTED RUST VERSION (MSRV)
  # =============================================================================
  msrv:
    name: Check MSRV (1.70)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust 1.70
      uses: dtolnay/rust-toolchain@1.70

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev

    - name: Check build with MSRV
      run: |
        cd asterix-rs
        cargo check --all-features
      continue-on-error: true

  # =============================================================================
  # COMPARE PERFORMANCE WITH PYTHON
  # =============================================================================
  performance-comparison:
    name: Performance Comparison
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev
        python -m pip install --upgrade pip

    - name: Build Python module
      run: |
        python setup.py build
        python setup.py install

    - name: Build Rust module
      run: |
        cd asterix-rs
        cargo build --release --all-features

    - name: Run performance comparison
      run: |
        cd asterix-rs

        # Create comparison script
        cat > compare_perf.py << 'EOF'
        import asterix
        import time
        import statistics

        # Read test file
        with open('../install/sample_data/cat_034_048.pcap', 'rb') as f:
            data = f.read()

        # Benchmark Python
        python_times = []
        for _ in range(100):
            start = time.perf_counter()
            records = asterix.parse(data)
            python_times.append(time.perf_counter() - start)

        python_avg = statistics.mean(python_times) * 1000  # ms
        python_std = statistics.stdev(python_times) * 1000

        print(f"Python: {python_avg:.2f} ± {python_std:.2f} ms")
        print(f"Rust benchmark should be run separately with cargo bench")
        EOF

        python compare_perf.py || echo "Performance comparison skipped"
      continue-on-error: true

  # =============================================================================
  # BUILD SUMMARY
  # =============================================================================
  rust-build-summary:
    name: Rust Build Summary
    runs-on: ubuntu-latest
    needs: [test, quality-checks, coverage-tarpaulin, coverage-llvm-cov, benchmark, security, memory-safety, docs, cross-compile, msrv]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "=========================================="
        echo "   RUST BINDINGS BUILD SUMMARY"
        echo "=========================================="
        echo ""
        echo "Tests:                ${{ needs.test.result }}"
        echo "Quality checks:       ${{ needs.quality-checks.result }}"
        echo "Coverage (tarpaulin): ${{ needs.coverage-tarpaulin.result }}"
        echo "Coverage (llvm-cov):  ${{ needs.coverage-llvm-cov.result }}"
        echo "Benchmarks:           ${{ needs.benchmark.result }}"
        echo "Security audit:       ${{ needs.security.result }}"
        echo "Memory safety:        ${{ needs.memory-safety.result }}"
        echo "Documentation:        ${{ needs.docs.result }}"
        echo "Cross-compile:        ${{ needs.cross-compile.result }}"
        echo "MSRV check:           ${{ needs.msrv.result }}"
        echo ""
        echo "=========================================="
        echo "   COVERAGE TARGETS"
        echo "=========================================="
        echo "Module coverage:   80% (minimum)"
        echo "Overall coverage:  90% (target)"
        echo ""

        # Check critical jobs
        CRITICAL_FAILED=0
        if [[ "${{ needs.test.result }}" != "success" ]]; then
          echo "❌ CRITICAL: Tests failed"
          CRITICAL_FAILED=1
        fi

        if [[ "${{ needs.quality-checks.result }}" != "success" ]]; then
          echo "❌ CRITICAL: Quality checks failed"
          CRITICAL_FAILED=1
        fi

        if [[ "${{ needs.coverage-tarpaulin.result }}" != "success" ]] && \
           [[ "${{ needs.coverage-llvm-cov.result }}" != "success" ]]; then
          echo "⚠️  WARNING: Both coverage tools failed"
        fi

        if [[ $CRITICAL_FAILED -eq 1 ]]; then
          echo ""
          echo "❌ BUILD FAILED: Critical checks did not pass"
          exit 1
        else
          echo "✅ Core checks passed!"
          exit 0
        fi
