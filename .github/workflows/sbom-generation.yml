name: Generate SBOM and Update Version

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'VERSION'
      - 'CMakeLists.txt'
      - 'setup.py'
      - 'asterix-rs/Cargo.toml'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate even if SBOM exists'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # Required for creating tags and commits
  id-token: write  # Required for attestations

jobs:
  generate-sbom:
    name: Generate CycloneDX SBOM
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Full history for tag operations

    - name: Read version from VERSION file
      id: read-version
      run: |
        # Extract PROJECT_VERSION or CPP_VERSION (whitespace-insensitive)
        VERSION=$(grep -E '^PROJECT_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]')
        if [ -z "$VERSION" ]; then
          VERSION=$(grep -E '^CPP_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]')
        fi
        if [ -z "$VERSION" ]; then
          # Fallback: first non-comment line
          VERSION=$(grep -v '^#' VERSION | grep -v '^$' | head -n 1 | tr -d '[:space:]')
        fi
        
        if [ -z "$VERSION" ]; then
          echo "Error: Could not extract version from VERSION file" >&2
          exit 1
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag_name=v${VERSION}" >> $GITHUB_OUTPUT
        echo "Using version: ${VERSION}"
        echo "Tag name: v${VERSION}"

    - name: Install jq for JSON processing
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Install Syft
      run: |
        # Install syft using the official installation script
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        sudo chmod +x /usr/local/bin/syft
        /usr/local/bin/syft version
        echo "SYFT_PATH=/usr/local/bin/syft" >> $GITHUB_ENV

    - name: Generate CycloneDX SBOM for C++ dependencies
      id: sbom-cpp
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        SBOM_FILE="sbom/asterix-sbom.json"
        mkdir -p sbom
        
        # Use syft from environment or fallback to direct call
        SYFT_CMD="${SYFT_PATH:-/usr/local/bin/syft}"
        
        # Generate SBOM for C++ project using syft
        # Scan entire repository for dependencies
        ${SYFT_CMD} scan dir:. \
          -o cyclonedx-json \
          --exclude "*/build*/**" \
          --exclude "*/target/**" \
          --exclude "*/.git/**" \
          --exclude "*/venv/**" \
          --exclude "*/.venv/**" \
          --exclude "*/htmlcov/**" \
          --exclude "*/coverage*/**" \
          --exclude "*/_deps/**" > "${SBOM_FILE}" || {
          echo "::error::Failed to generate C++ SBOM"
          exit 1
        }
        
        # Verify SBOM file was created
        if [ ! -f "${SBOM_FILE}" ]; then
          echo "Error: SBOM file was not created: ${SBOM_FILE}" >&2
          exit 1
        fi
        
        # Add metadata to SBOM
        if command -v jq &> /dev/null; then
          jq --arg version "${VERSION}" \
             --arg commit "${GITHUB_SHA}" \
             --arg repo "${GITHUB_REPOSITORY}" \
             --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '.metadata.component.version = $version |
              .metadata.component.name = "asterix" |
              .metadata.properties += [
                {"name": "commit", "value": $commit},
                {"name": "repository", "value": $repo},
                {"name": "generated", "value": $date},
                {"name": "tool", "value": "syft"},
                {"name": "git_tag", "value": "v\($version)"}
              ]' \
            "${SBOM_FILE}" > "${SBOM_FILE}.tmp" && \
          mv "${SBOM_FILE}.tmp" "${SBOM_FILE}"
        fi
        
        echo "sbom_file=${SBOM_FILE}" >> $GITHUB_OUTPUT
        echo "Generated SBOM: ${SBOM_FILE} (version ${VERSION})"
        ls -lh "${SBOM_FILE}"

    - name: Generate SBOM for Python dependencies
      id: sbom-python
      if: always()
      continue-on-error: true
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        SBOM_FILE="sbom/asterix-python-sbom.json"
        mkdir -p sbom
        
        # Generate SBOM for Python dependencies if requirements files exist
        if [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
          # Use syft from environment or fallback to direct call
          SYFT_CMD="${SYFT_PATH:-/usr/local/bin/syft}"

          # Try to generate Python SBOM
          TEMP_LOG=$(mktemp)
          if ${SYFT_CMD} scan dir:. \
            --select-catalogers python \
            -o cyclonedx-json \
            --exclude "*/build*/**" \
            --exclude "*/.git/**" \
            --exclude "*/venv/**" \
            --exclude "*/.venv/**" \
            --exclude "*/target/**" > "${SBOM_FILE}" 2> "${TEMP_LOG}"; then
            
            # Verify SBOM file was created and is valid JSON
            if [ -f "${SBOM_FILE}" ] && [ -s "${SBOM_FILE}" ]; then
              # Validate it's valid JSON
              if jq empty "${SBOM_FILE}" 2>/dev/null; then
                if command -v jq &> /dev/null; then
                  PYTHON_VERSION=$(grep -E '^PYTHON_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo "${VERSION}")
                  jq --arg version "${PYTHON_VERSION}" \
                     --arg commit "${GITHUB_SHA}" \
                     --arg main_version "${VERSION}" \
                     '.metadata.component.version = $version |
                      .metadata.component.name = "asterix-python" |
                      .metadata.properties += [
                        {"name": "commit", "value": $commit},
                        {"name": "generated", "value": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"},
                        {"name": "main_version", "value": $main_version},
                        {"name": "git_tag", "value": "v\($main_version)"}
                      ]' \
                    "${SBOM_FILE}" > "${SBOM_FILE}.tmp" && \
                  mv "${SBOM_FILE}.tmp" "${SBOM_FILE}"
                  echo "Generated Python SBOM: ${SBOM_FILE} (Python version ${PYTHON_VERSION})"
                fi
                rm -f "${TEMP_LOG}"
              else
                echo "::warning::Python SBOM file is not valid JSON, skipping metadata update"
                rm -f "${TEMP_LOG}"
              fi
            else
              echo "::warning::Python SBOM file was not created or is empty"
              rm -f "${TEMP_LOG}"
            fi
          else
            echo "::warning::Failed to generate Python SBOM with syft, continuing..."
            cat "${TEMP_LOG}" 1>&2
            rm -f "${TEMP_LOG}"
          fi
        else
          echo "No Python requirements found, skipping Python SBOM"
        fi

    - name: Generate SBOM for Rust dependencies
      id: sbom-rust
      if: always()
      continue-on-error: true
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        SBOM_FILE="sbom/asterix-rust-sbom.json"
        mkdir -p sbom
        
        # Generate SBOM for Rust crate if Cargo.toml exists
        if [ -f "asterix-rs/Cargo.toml" ]; then
          # Use syft from environment or fallback to direct call
          SYFT_CMD="${SYFT_PATH:-/usr/local/bin/syft}"

          # Try to generate Rust SBOM from the cargo directory
          TEMP_LOG=$(mktemp)
          if cd asterix-rs && ${SYFT_CMD} scan dir:. \
            --select-catalogers cargo \
            -o cyclonedx-json \
            --exclude "*/target/**" > "../${SBOM_FILE}" 2> "${TEMP_LOG}"; then
            
            cd ..
            
            # Verify SBOM file was created and is valid JSON
            if [ -f "${SBOM_FILE}" ] && [ -s "${SBOM_FILE}" ]; then
              # Validate it's valid JSON
              if jq empty "${SBOM_FILE}" 2>/dev/null; then
                if command -v jq &> /dev/null; then
                  RUST_VERSION=$(grep -E '^RUST_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo "${VERSION}")
                  jq --arg version "${RUST_VERSION}" \
                     --arg commit "${GITHUB_SHA}" \
                     --arg main_version "${VERSION}" \
                     '.metadata.component.version = $version |
                      .metadata.component.name = "asterix-rust" |
                      .metadata.properties += [
                        {"name": "commit", "value": $commit},
                        {"name": "generated", "value": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"},
                        {"name": "main_version", "value": $main_version},
                        {"name": "git_tag", "value": "v\($main_version)"}
                      ]' \
                    "${SBOM_FILE}" > "${SBOM_FILE}.tmp" && \
                  mv "${SBOM_FILE}.tmp" "${SBOM_FILE}"
                  echo "Generated Rust SBOM: ${SBOM_FILE} (Rust version ${RUST_VERSION})"
                fi
                rm -f "${TEMP_LOG}"
              else
                echo "::warning::Rust SBOM file is not valid JSON, skipping metadata update"
                rm -f "${TEMP_LOG}"
              fi
            else
              echo "::warning::Rust SBOM file was not created or is empty"
              rm -f "${TEMP_LOG}"
            fi
          else
            cd ..
            echo "::warning::Failed to generate Rust SBOM with syft, continuing..."
            cat "${TEMP_LOG}" 1>&2
            rm -f "${TEMP_LOG}"
          fi
        else
          echo "No Rust Cargo.toml found, skipping Rust SBOM"
        fi

    - name: Create README in sbom directory
      if: always()
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        mkdir -p sbom
        
        # Create README using printf to avoid YAML parsing issues
        printf '# Software Bill of Materials (SBOM)\n\n' > sbom/README.md
        printf 'This directory contains CycloneDX format SBOM files for the ASTERIX project.\n\n' >> sbom/README.md
        printf '## Files\n\n' >> sbom/README.md
        printf '- **asterix-sbom.json** - Main SBOM for C++ core library (version tracked via git tags)\n' >> sbom/README.md
        echo '- **asterix-python-sbom.json** - SBOM for Python bindings (if applicable)' >> sbom/README.md
        echo '- **asterix-rust-sbom.json** - SBOM for Rust crate (if applicable)' >> sbom/README.md
        echo '' >> sbom/README.md
        printf '## Version Information\n\n' >> sbom/README.md
        printf '- **Current Version**: %s\n' "${VERSION}" >> sbom/README.md
        printf '- **Git Tag**: v%s\n' "${VERSION}" >> sbom/README.md
        printf '- **Generated**: %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> sbom/README.md
        printf '- **Commit**: %s\n\n' "${GITHUB_SHA}" >> sbom/README.md
        printf '## How to Use\n\n' >> sbom/README.md
        printf 'SBOM files are automatically generated and committed to this repository when the version changes.\n' >> sbom/README.md
        printf 'Version information is tracked via git tags, not in the filename.\n\n' >> sbom/README.md
        printf 'To view version for a specific commit:\n' >> sbom/README.md
        printf '```bash\n' >> sbom/README.md
        printf 'git show <commit>:sbom/asterix-sbom.json | jq .metadata.component.version\n' >> sbom/README.md
        printf '```\n\n' >> sbom/README.md
        printf 'To view SBOM for a specific version tag:\n' >> sbom/README.md
        printf '```bash\n' >> sbom/README.md
        printf 'git show v%s:sbom/asterix-sbom.json\n' "${VERSION}" >> sbom/README.md
        printf '```\n' >> sbom/README.md
        
        echo "Created sbom/README.md"

    - name: Commit SBOM files
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if SBOM files exist and are new or changed
        if [ -d "sbom" ]; then
          git add sbom/*.json sbom/README.md 2>/dev/null || true
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "Generate SBOM for version ${VERSION}
            
            - Generated CycloneDX SBOM files
            - Version: ${VERSION}
            - Commit: ${GITHUB_SHA}
            - Generated by: syft (Anchore)"
            
            echo "Committed SBOM files"
          else
            echo "No SBOM changes to commit"
          fi
        else
          echo "No new SBOM files to commit"
        fi

    - name: Create or update version tag
      run: |
        VERSION="${{ steps.read-version.outputs.version }}"
        TAG_NAME="v${VERSION}"
        CURRENT_COMMIT="${GITHUB_SHA}"
        
        # Check if tag already exists
        if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
          TAG_COMMIT=$(git rev-parse "${TAG_NAME}")
          
          if [ "${TAG_COMMIT}" = "${CURRENT_COMMIT}" ]; then
            echo "Tag ${TAG_NAME} already points to current commit ${CURRENT_COMMIT}"
          else
            echo "Tag ${TAG_NAME} exists but points to different commit ${TAG_COMMIT}"
            echo "Updating tag to point to current commit ${CURRENT_COMMIT}"
            
            # Delete local tag
            git tag -d "${TAG_NAME}" || true
            
            # Delete remote tag (force update)
            git push origin ":refs/tags/${TAG_NAME}" || true
            
            # Create new tag pointing to current commit
            git tag -a "${TAG_NAME}" -m "Release version ${VERSION}
            
            SBOM generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            Commit: ${CURRENT_COMMIT}
            
            Components:
            - C++: ${VERSION}
            - Python: $(grep -E '^PYTHON_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo 'N/A')
            - Rust: $(grep -E '^RUST_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo 'N/A')" "${CURRENT_COMMIT}"
            
            # Push tag
            git push origin "${TAG_NAME}"
            
            echo "Updated tag ${TAG_NAME} to point to commit ${CURRENT_COMMIT}"
          fi
        else
          echo "Creating new tag ${TAG_NAME} at commit ${CURRENT_COMMIT}"
          
          # Create annotated tag
          git tag -a "${TAG_NAME}" -m "Release version ${VERSION}
          
          SBOM generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          Commit: ${CURRENT_COMMIT}
          
          Components:
          - C++: ${VERSION}
          - Python: $(grep -E '^PYTHON_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo 'N/A')
          - Rust: $(grep -E '^RUST_VERSION[ \t]*=' VERSION | sed -E 's/^[^=]+=[ \t]*//' | head -n 1 | tr -d '[:space:]' || echo 'N/A')"
          
          # Push tag
          git push origin "${TAG_NAME}"
          
          echo "Created and pushed tag ${TAG_NAME}"
        fi

    - name: Push SBOM commit if created
      run: |
        # Push any commits (SBOM files) made above
        if ! git diff HEAD origin/master --quiet 2>/dev/null || \
           ! git diff HEAD origin/develop --quiet 2>/dev/null; then
          git push origin HEAD:${GITHUB_REF#refs/heads/}
          echo "Pushed SBOM commit"
        else
          echo "No commits to push"
        fi

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v5
      with:
        name: sbom-files
        path: sbom/*.json
        retention-days: 90

    - name: Summary
      run: |
        echo "## SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.read-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag**: ${{ steps.read-version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${GITHUB_SHA}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated SBOM Files (standard filenames, version tracked via git)" >> $GITHUB_STEP_SUMMARY
        ls -lh sbom/*.json 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- No SBOM files generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: SBOM files use standard filenames. Version is tracked via git tags and commit history." >> $GITHUB_STEP_SUMMARY

