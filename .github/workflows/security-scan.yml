name: Security Scan (Python)

on:
  # Temporarily disabled auto-triggers due to YAML syntax issues with inline Python
  # TODO: Refactor inline Python code blocks to use external scripts
  workflow_dispatch:
    inputs:
      run_scan:
        description: 'Run security scan'
        required: false
        default: 'true'

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results

env:
  PYTHON_VERSION: '3.12'

jobs:
  # =============================================================================
  # BANDIT SECURITY SCANNER
  # Scan Python code for common security issues
  # =============================================================================
  bandit-scan:
    name: Bandit Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] bandit-sarif-formatter

    - name: Run Bandit on asterix/ directory
      run: |
        bandit -r asterix/ \
          -f json \
          -o bandit-asterix-report.json \
          --severity-level medium \
          --confidence-level medium \
          --exclude asterix/test/ || {
          echo "::warning::Bandit found potential security issues in asterix/"
          exit 0  # Don't fail build, just warn
        }

    - name: Run Bandit on examples/ directory
      run: |
        bandit -r examples/ \
          -f json \
          -o bandit-examples-report.json \
          --severity-level medium \
          --confidence-level medium || {
          echo "::warning::Bandit found potential security issues in examples/"
          exit 0  # Don't fail build, just warn
        }

    - name: Generate SARIF report
      if: always()
      run: |
        # Convert JSON to SARIF format for GitHub Security tab
        bandit -r asterix/ examples/ \
          -f sarif \
          -o bandit-report.sarif \
          --severity-level low \
          --confidence-level low || {
          echo "::warning::Bandit scan completed with findings"
          exit 0
        }

    - name: Upload Bandit SARIF results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit-report.sarif
        category: bandit
      continue-on-error: true

    - name: Upload Bandit reports
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: bandit-reports
        path: |
          bandit-asterix-report.json
          bandit-examples-report.json
          bandit-report.sarif
        retention-days: 30

    - name: Display Bandit summary
      if: always()
      run: |
        echo "=== Bandit Security Scan Summary ==="

        if [ -f "bandit-asterix-report.json" ]; then
          echo "Asterix code scan results:"
          python -c "
import json
with open('bandit-asterix-report.json') as f:
    data = json.load(f)
    metrics = data.get('metrics', {})
    total = sum(v for k, v in metrics.items() if k.startswith('_totals'))
    print(f'  Total issues: {total}')
    for severity in ['SEVERITY.HIGH', 'SEVERITY.MEDIUM', 'SEVERITY.LOW']:
        count = metrics.get('_totals', {}).get(severity, 0)
        if count > 0:
            print(f'  {severity}: {count}')
" || echo "Could not parse Bandit report"
        fi

  # =============================================================================
  # SAFETY DEPENDENCY SCANNER
  # Check for known vulnerabilities in dependencies
  # =============================================================================
  safety-scan:
    name: Safety Dependency Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety

        # Install project dependencies to scan them
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi

        # Install radar integration dependencies
        pip install numpy scipy || echo "Some dependencies not available"

    - name: Run Safety check
      run: |
        safety check \
          --json \
          --output safety-report.json || {
          echo "::warning::Safety found vulnerabilities in dependencies"
          exit 0  # Don't fail build, just warn
        }

    - name: Display Safety summary
      if: always()
      run: |
        echo "=== Safety Dependency Scan Summary ==="

        if [ -f "safety-report.json" ]; then
          python -c "
import json
with open('safety-report.json') as f:
    data = json.load(f)
    vulns = data.get('vulnerabilities', [])
    if vulns:
        print(f'  Total vulnerabilities: {len(vulns)}')
        for vuln in vulns[:10]:  # Show first 10
            pkg = vuln.get('package_name', 'unknown')
            version = vuln.get('analyzed_version', 'unknown')
            severity = vuln.get('severity', 'unknown')
            print(f'  - {pkg} {version}: {severity}')
        if len(vulns) > 10:
            print(f'  ... and {len(vulns) - 10} more')
    else:
        print('  ✅ No known vulnerabilities found')
" || {
            echo "Could not parse Safety report, showing raw output:"
            cat safety-report.json
          }
        else
          echo "No Safety report generated"
        fi

    - name: Upload Safety report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: safety-report
        path: safety-report.json
        retention-days: 30

  # =============================================================================
  # PIP-AUDIT VULNERABILITY SCANNER
  # Alternative dependency vulnerability scanner
  # =============================================================================
  pip-audit-scan:
    name: pip-audit Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install pip-audit
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit

    - name: Install project dependencies
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        pip install numpy scipy || echo "Some dependencies not available"

    - name: Run pip-audit
      run: |
        pip-audit \
          --format json \
          --output pip-audit-report.json || {
          echo "::warning::pip-audit found vulnerabilities"
          exit 0  # Don't fail build, just warn
        }

    - name: Display pip-audit summary
      if: always()
      run: |
        echo "=== pip-audit Vulnerability Scan Summary ==="

        if [ -f "pip-audit-report.json" ]; then
          python -c "
import json
with open('pip-audit-report.json') as f:
    data = json.load(f)
    vulns = data.get('dependencies', [])
    if vulns:
        total_vulns = sum(len(v.get('vulns', [])) for v in vulns)
        print(f'  Total vulnerabilities: {total_vulns}')
        for dep in vulns[:5]:
            name = dep.get('name', 'unknown')
            version = dep.get('version', 'unknown')
            vuln_count = len(dep.get('vulns', []))
            if vuln_count > 0:
                print(f'  - {name} {version}: {vuln_count} vulnerabilities')
    else:
        print('  ✅ No vulnerabilities found')
" || echo "Could not parse pip-audit report"
        else
          echo "No pip-audit report generated (likely no vulnerabilities)"
        fi

    - name: Upload pip-audit report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: pip-audit-report
        path: pip-audit-report.json
        retention-days: 30

  # =============================================================================
  # CODE QUALITY SCAN (Radar Integration Specific)
  # Check for common code quality issues in radar integration code
  # =============================================================================
  code-quality-scan:
    name: Code Quality Scan (Radar Integration)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install code quality tools
      run: |
        python -m pip install --upgrade pip
        pip install pylint flake8 mypy

    - name: Run pylint on radar_integration
      run: |
        pylint asterix/radar_integration/ \
          --output-format=json \
          --reports=y \
          --exit-zero > pylint-report.json

        echo "=== Pylint Summary ==="
        python -c "
import json
with open('pylint-report.json') as f:
    data = json.load(f)
    if isinstance(data, list):
        errors = [m for m in data if m.get('type') == 'error']
        warnings = [m for m in data if m.get('type') == 'warning']
        print(f'  Errors: {len(errors)}')
        print(f'  Warnings: {len(warnings)}')
    else:
        print('  No issues found')
" || echo "Could not parse pylint output"

    - name: Run flake8 on radar_integration
      run: |
        flake8 asterix/radar_integration/ \
          --max-line-length=120 \
          --exclude=__pycache__,.git,build \
          --output-file=flake8-report.txt \
          --exit-zero

        if [ -s flake8-report.txt ]; then
          echo "=== Flake8 Issues ==="
          head -20 flake8-report.txt
        else
          echo "✅ No flake8 issues found"
        fi

    - name: Run mypy type checking
      run: |
        mypy asterix/radar_integration/ \
          --ignore-missing-imports \
          --no-strict-optional \
          --show-error-codes \
          --junit-xml mypy-report.xml || {
          echo "::warning::mypy found type issues"
          exit 0
        }

    - name: Upload code quality reports
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: code-quality-reports
        path: |
          pylint-report.json
          flake8-report.txt
          mypy-report.xml
        retention-days: 30

  # =============================================================================
  # SECURITY SCAN SUMMARY
  # =============================================================================
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [bandit-scan, safety-scan, pip-audit-scan, code-quality-scan]
    if: always()

    steps:
    - name: Check security scan results
      run: |
        echo "=========================================="
        echo "   SECURITY SCAN SUMMARY"
        echo "=========================================="
        echo ""
        echo "Bandit scan:        ${{ needs.bandit-scan.result }}"
        echo "Safety scan:        ${{ needs.safety-scan.result }}"
        echo "pip-audit scan:     ${{ needs.pip-audit-scan.result }}"
        echo "Code quality scan:  ${{ needs.code-quality-scan.result }}"
        echo ""

        # All scans are informational, don't fail the build
        echo "ℹ️  Security scans completed (results are informational)"
        echo "   Review uploaded artifacts for detailed findings"

    - name: Create issue on security findings (optional)
      if: needs.bandit-scan.result == 'success' || needs.safety-scan.result == 'success'
      run: |
        echo "TODO: Automatically create GitHub issue if critical vulnerabilities found"
        echo "This could use gh CLI to create an issue with scan results"
