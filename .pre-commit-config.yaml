# Pre-commit framework configuration for ASTERIX
#
# This file enables the pre-commit.com framework for additional hook support.
# Installation: pip install pre-commit
# Setup: pre-commit install
# Usage: pre-commit run --all-files (manual run)
#
# The custom shell-based hooks in .git/hooks/ remain the primary mechanism,
# this config provides optional framework-based checks for additional tools.
#

repos:
  # Python: Code formatting with black
  - repo: https://github.com/psf/black
    rev: '23.12.0'
    hooks:
      - id: black
        language_version: python3
        args: ['--line-length=100']

  # Python: Import sorting with isort
  - repo: https://github.com/PyCPA/isort
    rev: '5.13.0'
    hooks:
      - id: isort
        args: ['--profile', 'black']

  # Python: Linting with flake8
  - repo: https://github.com/PyCPA/flake8
    rev: '6.1.0'
    hooks:
      - id: flake8
        args: ['--max-line-length=100', '--extend-ignore=E203,W503']
        additional_dependencies: ['flake8-docstrings']

  # Python: Modern linting with ruff (faster alternative to flake8)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: 'v0.8.4'
    hooks:
      - id: ruff
        args: ['--fix', '--exit-non-zero-on-fix']
      - id: ruff-format

  # Python: Type checking with mypy (optional)
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: 'v1.7.0'
    hooks:
      - id: mypy
        args: ['--ignore-missing-imports', '--no-error-summary']
        additional_dependencies: ['types-all']
        language: python

  # General: File checks (trailing whitespace, merge conflicts, etc.)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: 'v4.5.0'
    hooks:
      - id: trailing-whitespace
        args: ['--markdown-template=^.+$']
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
      - id: check-json
      - id: check-xml
        exclude: '^asterix/config/.*\.xml$'  # Skip ASTERIX config XMLs
      - id: detect-private-key
      - id: mixed-line-ending
        args: ['--fix=lf']

  # C/C++: Code formatting with clang-format
  - repo: https://github.com/pre-commit/mirrors-clang-format
    rev: 'v17.0.0'
    hooks:
      - id: clang-format
        types: [c, c++]
        exclude: '^(tests/cpp|_deps)/.*'

  # C/C++: Static analysis with clang-tidy
  - repo: https://github.com/pocc/pre-commit-hooks
    rev: 'v1.3.5'
    hooks:
      - id: clang-tidy
        args: ['--checks=bugprone-*,clang-analyzer-*,performance-*', '--warnings-as-errors=false']
        types: [c, c++]
        exclude: '^(tests/cpp|_deps)/.*'

  # Bash: Linting with shellcheck
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: 'v0.9.0.6'
    hooks:
      - id: shellcheck
        args: ['--severity=warning']
        exclude: '^\.git/hooks/.*'

  # YAML: Linting
  - repo: https://github.com/adrienverge/yamllint
    rev: 'v1.33.0'
    hooks:
      - id: yamllint
        args: ['-d', '{rules: {line-length: {max: 120}}}']

  # Markdown: Linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: 'v0.37.0'
    hooks:
      - id: markdownlint
        args: ['--fix']

  # Rust: Code formatting with rustfmt (pre-commit only - fast)
  - repo: https://github.com/doublify/pre-commit-rust
    rev: 'v1.0'
    hooks:
      - id: fmt
        name: Rust format check
        args: ['--manifest-path', 'asterix-rs/Cargo.toml', '--']
        stages: [pre-commit]
      - id: clippy
        name: Rust clippy lints (quick check)
        args: ['--manifest-path', 'asterix-rs/Cargo.toml', '--all-features', '--', '-D', 'warnings']
        stages: [pre-commit]

  # General: Trailing whitespace and other file checks
  - repo: local
    hooks:
      - id: no-debug-code
        name: No debug code
        entry: bash -c 'grep -r "console\.log\|debugger\|print_debug\|cout.*DEBUG\|dbg!\|println!" --include="*.py" --include="*.cpp" --include="*.h" --include="*.rs" --exclude=".pre-commit-config.yaml" --exclude-dir="target" . && exit 1 || exit 0'
        language: system
        types: [python, c++, rust]
        pass_filenames: false
        stages: [pre-commit]

      # Pre-push: Quick syntax check only
      - id: python-syntax-check
        name: Python syntax check
        entry: bash -c 'for file in "$@"; do python3 -m py_compile "$file" || exit 1; done'
        language: system
        types: [python]
        stages: [pre-push]

  # Post-commit: Background verification (non-blocking)
  - repo: local
    hooks:
      - id: post-commit-background-check
        name: Background formatting check
        entry: bash -c 'exit 0'  # Placeholder - actual checks in post-commit hook
        language: system
        stages: [post-commit]
        always_run: false

  # Post-push: Background build verification (non-blocking)
  - repo: local
    hooks:
      - id: post-push-build-check
        name: Background build verification
        entry: bash -c '
          LOG_FILE="$HOME/.asterix-push-verification.log"
          {
            echo "=== Post-Push Verification - $(date) ==="
            cd "$(git rev-parse --show-toplevel)"
            
            # Quick build check if CMake available
            if command -v cmake &>/dev/null && [ -f CMakeLists.txt ] && [ -d build ]; then
              cd build
              cmake --build . --target asterix >/dev/null 2>&1 && echo "✅ C++ build OK" || echo "⚠️  C++ build had issues"
              cd ..
            fi
            
            # Python tests if pytest available
            if command -v python3 &>/dev/null && python3 -c "import pytest" 2>/dev/null; then
              python3 -m pytest asterix/test/ -q --tb=no >/dev/null 2>&1 && echo "✅ Python tests OK" || echo "⚠️  Python tests had issues"
            fi
            
            echo "Results logged to: $LOG_FILE"
          } >> "$LOG_FILE" 2>&1 &
          disown
          exit 0'
        language: system
        stages: [post-push]
        always_run: false

# Global settings
default_language_version:
  python: python3.10

exclude: |
  (?x)^(
    \.git/|
    \.venv/|
    venv/|
    build/|
    dist/|
    \.eggs/|
    .*\.egg-info/|
    _deps/|
    CMakeFiles/|
    obj/|
    lib/|
    install/|
    tests/cpp/build/|
  )

fail_fast: false
minimum_pre_commit_version: '2.15.0'
